(function(p,M){typeof exports=="object"&&typeof module<"u"?M(exports,require("three")):typeof define=="function"&&define.amd?define(["exports","three"],M):(p=typeof globalThis<"u"?globalThis:p||self,M(p["shared-nodetoy"]={},p.THREE))})(this,function(p,M){"use strict";var ie=Object.defineProperty;var oe=(p,M,j)=>M in p?ie(p,M,{enumerable:!0,configurable:!0,writable:!0,value:j}):p[M]=j;var x=(p,M,j)=>(oe(p,typeof M!="symbol"?M+"":M,j),j);function j(n){if(n&&n.__esModule)return n;const t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(n){for(const e in n)if(e!=="default"){const r=Object.getOwnPropertyDescriptor(n,e);Object.defineProperty(t,e,r.get?r:{enumerable:!0,get:()=>n[e]})}}return t.default=n,Object.freeze(t)}const _=j(M),G=(n,t={})=>{U("event",n,t)},W=(n,t={})=>{if(typeof window>"u")return;const e="ga-gtag";if(document.getElementById(e)){console.error("Already has a gtag script.");return}const{head:r}=document,i=document.createElement("script");i.id=e,i.type="text/javascript",i.async=!0,i.src=`https://www.googletagmanager.com/gtag/js?id=${n}`,r.insertBefore(i,r.firstChild),window.dataLayer=window.dataLayer||[],U("js",new Date),U("config",n,t)},U=function(...n){window.dataLayer.push(arguments)},N=new _.TextureLoader,L={},h={state:0,stateFrame:0,button:0,viewportState:0,viewportStateFrame:0,x:0,y:0};class X extends _.DataTexture{constructor(){const c=new Uint8Array(1024);for(let y=0;y<4*256;y++)c[y]=0;super(c,256,1,_.RGBAFormat);x(this,"data");x(this,"_size");this.data=c,this.flipY=!0,this._size=256}setKeyDown(e){const r=e*4;this.data[r+0]!==255&&(this.data[r+0]=255,this.data[r+1]=255,this.data[r+2]=255-this.data[r+2],this.needsUpdate=!0)}setKeyUp(e){const r=e*4;this.data[r+0]=0,this.data[r+1]=0,this.needsUpdate=!0}clear(){for(let e=0;e<4*this._size;e++)this.data[e]=0;this.needsUpdate=!0}clearFrame(){for(let e=0;e<this._size;e++){const r=e*4;this.data[r+1]=0}this.needsUpdate=!0}}class Y{constructor(t){x(this,"renderer");x(this,"_keyboardTexture",new X);x(this,"_onPointerMoveBind");x(this,"_onPointerDownBind");x(this,"_onPointerUpBind");x(this,"_onPointerEnterBind");x(this,"_onPointerLeaveBind");x(this,"_onKeyDownBind");x(this,"_onKeyUpBind");this.renderer=t,this.renderer._pointerPosition={x:0,y:0},this.renderer._pointerData=h,this.renderer._keyboardTexture=this._keyboardTexture;const e=t.domElement;if(!e){console.warn("[NodeToy] Unable to bind dom events, domElement is null. Some nodes will not work.");return}this._onPointerMoveBind=this.onPointerMove.bind(this),this._onPointerDownBind=this.onPointerDown.bind(this),this._onPointerUpBind=this.onPointerUp.bind(this),this._onPointerEnterBind=this.onPointerEnter.bind(this),this._onPointerLeaveBind=this.onPointerLeave.bind(this),this._onKeyDownBind=this.onKeyDown.bind(this),this._onKeyUpBind=this.onKeyUp.bind(this),e.addEventListener("pointermove",this._onPointerMoveBind),e.addEventListener("pointerdown",this._onPointerDownBind),e.addEventListener("pointerup",this._onPointerUpBind),e.addEventListener("pointerenter",this._onPointerEnterBind),e.addEventListener("pointerleave",this._onPointerLeaveBind),window.addEventListener("keydown",this._onKeyDownBind),window.addEventListener("keyup",this._onKeyUpBind)}dispose(){if(!this.renderer)return;const t=this.renderer.domElement;!t||(t.removeEventListener("pointermove",this._onPointerMoveBind),t.removeEventListener("pointerdown",this._onPointerDownBind),t.removeEventListener("pointerup",this._onPointerUpBind),t.removeEventListener("pointerenter",this._onPointerEnterBind),t.removeEventListener("pointerleave",this._onPointerLeaveBind),window.removeEventListener("keydown",this._onKeyDownBind),window.removeEventListener("keyup",this._onKeyUpBind))}onPointerMove(t){!this.renderer||(this.renderer._pointerPosition={x:Math.floor(t.offsetX),y:Math.floor(t.offsetY)})}onPointerDown(t){!this.renderer||(this.renderer._pointerData={...this.renderer._pointerData,state:1,stateFrame:1,button:t.button,x:Math.floor(t.offsetX),y:Math.floor(t.offsetY)})}onPointerUp(t){!this.renderer||(this.renderer._pointerData={...this.renderer._pointerData,state:2,stateFrame:2,button:t.button,x:Math.floor(t.offsetX),y:Math.floor(t.offsetY)})}onPointerEnter(t){!this.renderer||(this.renderer._pointerData={...this.renderer._pointerData,viewportState:1,viewportStateFrame:1,x:Math.floor(t.offsetX),y:Math.floor(t.offsetY)})}onPointerLeave(t){!this.renderer||(this.renderer._pointerData={...this.renderer._pointerData,viewportState:2,viewportStateFrame:2,x:Math.floor(t.offsetX),y:Math.floor(t.offsetY)})}onKeyDown(t){!this.renderer||this._keyboardTexture.setKeyDown(t.keyCode)}onKeyUp(t){!this.renderer||this._keyboardTexture.setKeyUp(t.keyCode)}}const $=n=>n.includes(".json")?n:`${n}${n[n.length-1]!="/"?"/":""}material.glsl.json`,q=(n,t)=>{if(!n||!t.includes("asset:"))return t;const e=n[n.length-1];return`${n}${e!=="/"?"/":""}assets/${t.replace("asset:","")}`},I=(n,t,e,r={})=>{const i=t;for(let c=0;c<e.length;c++){const y=e[c],v=y.name in r?r[y.name]:y.value;i[y.name]={value:z(n,y.type,v),type:y.type}}return i},z=(n,t,e)=>{switch(t){case"int":case"float":return e!=null,e;case"vec2":return e!=null?new _.Vector2(e.x,e.y):new _.Vector2(0,0);case"vec3":return e!=null?new _.Vector3(e.x,e.y,e.z):new _.Vector3(0,0,0);case"vec4":return e!=null?new _.Vector4(e.x,e.y,e.z,e.w):new _.Vector4(0,0,0);case"mat3":return e||new _.Matrix3;case"mat4":return e||new _.Matrix4;case"texture":{if(e in L)return L[e];const r=N.load(q(n,e));return r.wrapS=r.wrapT=_.RepeatWrapping,L[e]=r,r}}return"undefined"},H=()=>{W("G-D7559MFFX3")},m=()=>{W("G-PHS6B2766W")},J=(n,t)=>{for(let e=0;e<n.scene.children.length;e++)if(n.scene.children[e].isDirectionalLight){n.light=n.scene.children[e];break}if("_sinTime"in t){const e=Math.sin(n.time);t._sinTime.value.set(e/8,e/4,e/2,e)}if("_cosTime"in t){const e=Math.cos(n.time);t._cosTime.value.set(e/8,e/4,e/2,e)}if("_objectScale"in t){const e=n.object;t._objectScale.value=e.scale}if("_time"in t&&(t._time.value=n.time),"_deltaTime"in t&&t._deltaTime.value.set(n.deltaTime,1/n.deltaTime,0,0),"_objectSpaceViewDir"in t){const e=n.object,r=n.camera,i=new _.Vector4(r.position.x,r.position.y,r.position.z),c=e.matrixWorld.clone().invert().elements,y=c[0]*i.x+c[4]*i.y+c[8]*i.z+c[12]*i.w,v=c[1]*i.x+c[5]*i.y+c[9]*i.z+c[13]*i.w,l=c[2]*i.x+c[6]*i.y+c[10]*i.z+c[14]*i.w,a=c[3]*i.x+c[7]*i.y+c[11]*i.z+c[15]*i.w,s=new _.Vector4(y,v,l,a);t._objectSpaceViewDir.value=s}if("_cameraPosition"in t){const e=n.camera;t._cameraPosition.value=e.position.clone()}if("_worldSpaceCameraPosition"in t&&(n.camera.getWorldDirection(A),t._worldSpaceCameraPosition.value=A),"_worldSpaceLightPosition"in t&&(n.light.getWorldDirection(C),t._worldSpaceLightPosition.value=C),"_worldToObject"in t){const e=n.object;t._worldToObject.value=e.matrixWorld.clone().invert()}if("_worldToObjMatrix"in t&&(t._worldToObjMatrix.value=n.object.matrixWorld.clone().invert()),"_worldToCameraMatrix"in t){const e=n.camera;t._worldToCameraMatrix.value=e.matrixWorldInverse.clone()}if("_viewProjectionMatrix"in t){const e=n.camera,r=e.matrixWorld.clone();t._viewProjectionMatrix.value=e.projectionMatrix.clone().multiply(r)}if("_viewMatrix"in t){const e=n.camera;t._viewMatrix.value=e.matrixWorldInverse}if("_transposeModelViewMatrix"in t){const e=n.object;t._transposeModelViewMatrix.value=e.modelViewMatrix.clone().transpose()}if("_inverseTransposeModelViewMatrix"in t){const r=n.object.modelViewMatrix.clone();t._inverseTransposeModelViewMatrix.value=r.invert().transpose()}if("_projectionMatrix"in t){const e=n.camera;t._projectionMatrix.value=e.projectionMatrix}if("_projectionParams"in t){const e=n.camera;t._projectionParams.value=new _.Vector4(1,e.near,e.far,1/e.far)}if("_inverseProjectionMatrix"in t){const e=n.camera;t._inverseProjectionMatrix.value=e.projectionMatrixInverse}if("_objectToWorldMatrix"in t){const e=n.object;t._objectToWorldMatrix.value=e.matrixWorld}if("_modelViewProjectionMatrix"in t){const e=n.object,r=n.camera;r.updateMatrixWorld(!0),e.updateMatrixWorld(!0);const i=e.modelViewMatrix.clone();t._modelViewProjectionMatrix.value=r.projectionMatrix.clone().multiply(i)}if("_modelViewMatrix"in t){const e=n.object;n.camera.updateMatrixWorld(!0),e.updateMatrixWorld(!0),t._modelViewMatrix.value=e.modelViewMatrix.clone()}if("_inverseModelViewMatrix"in t){const e=n.object;n.camera.updateMatrixWorld(!0),e.updateMatrixWorld(!0),t._inverseModelViewMatrix.value=e.modelViewMatrix.clone().invert()}if("_modelMatrix"in t){const e=n.object;t._modelMatrix.value=e.matrixWorld}if("_normalMatrix"in t){const e=n.object;t._normalMatrix.value=e.normalMatrix}if("_inverseViewMatrix"in t){const e=n.camera;t._inverseViewMatrix.value=e.matrixWorldInverse.clone().invert()}if("_cameraToWorldMatrix"in t){const e=n.camera;t._cameraToWorldMatrix.value=e.matrixWorldInverse.clone().invert()}if("_worldSpaceLightDir"in t&&n.light&&(t._worldSpaceLightDir.value=new _.Vector3(n.light.rotation._x,n.light.rotation._y,n.light.rotation._z).normalize()),"_lightColor"in t&&n.light){const e=n.light.intensity,r=new _.Vector3(n.light.color.r*e,n.light.color.g*e,n.light.color.b*e);t._lightColor.value=r}if("_screenSize"in t&&(n.renderer.getSize(g),t._screenSize.value.set(Math.floor(g.x),Math.floor(g.y),1+1/Math.floor(g.x),1+1/Math.floor(g.y))),"_viewDir"in t&&(n.camera.getWorldDirection(S),S.negate(),t._viewDir.value=S),"_pointerPosition"in t){const e="_pointerPosition"in n.renderer?n.renderer._pointerPosition:{x:0,y:0};t._pointerPosition.value.set(Math.floor(e.x),Math.floor(e.y))}if("_pointerPositionNormalized"in t){n.renderer.getSize(g);const e="_pointerPosition"in n.renderer?n.renderer._pointerPosition:{x:0,y:0};t._pointerPositionNormalized.value.set(e.x/g.x,e.y/g.y)}if("_pointerDown"in t){const e="_pointerData"in n.renderer?n.renderer._pointerData:h;t._pointerDown.value.set(e.state===1?1:0,e.button)}if("_pointerDownPrimary"in t){const e="_pointerData"in n.renderer?n.renderer._pointerData:h;e.button===0&&t._pointerDownPrimary.value.set(e.state===1?1:0,e.button)}if("_pointerDownAuxiliary"in t){const e="_pointerData"in n.renderer?n.renderer._pointerData:h;e.button===1&&t._pointerDownAuxiliary.value.set(e.state===1?1:0,e.button)}if("_pointerDownSecondary"in t){const e="_pointerData"in n.renderer?n.renderer._pointerData:h;e.button===2&&t._pointerDownSecondary.value.set(e.state===1?1:0,e.button)}if("_pointerDownFrame"in t){const e="_pointerData"in n.renderer?n.renderer._pointerData:h;t._pointerDownFrame.value.set(e.stateFrame===1?1:0,e.button)}if("_pointerDownPrimaryFrame"in t){const e="_pointerData"in n.renderer?n.renderer._pointerData:h;e.button===0&&t._pointerDownPrimaryFrame.value.set(e.stateFrame===1?1:0,e.button)}if("_pointerDownAuxiliaryFrame"in t){const e="_pointerData"in n.renderer?n.renderer._pointerData:h;e.button===1&&t._pointerDownAuxiliaryFrame.value.set(e.stateFrame===1?1:0,e.button)}if("_pointerDownSecondaryFrame"in t){const e="_pointerData"in n.renderer?n.renderer._pointerData:h;e.button===2&&t._pointerDownSecondaryFrame.value.set(e.stateFrame===1?1:0,e.button)}if("_pointerUp"in t){const e="_pointerData"in n.renderer?n.renderer._pointerData:h;t._pointerUp.value.set(e.state===0||e.state===2?1:0,e.button)}if("_pointerUpPrimary"in t){const e="_pointerData"in n.renderer?n.renderer._pointerData:h;e.button===0?t._pointerUpPrimary.value.set(e.state===0||e.state===2?1:0,e.button):t._pointerUpPrimary.value.set(1,e.button)}if("_pointerUpAuxiliary"in t){const e="_pointerData"in n.renderer?n.renderer._pointerData:h;e.button===1?t._pointerUpAuxiliary.value.set(e.state===0||e.state===2?1:0,e.button):t._pointerUpAuxiliary.value.set(1,e.button)}if("_pointerUpSecondary"in t){const e="_pointerData"in n.renderer?n.renderer._pointerData:h;e.button===2?t._pointerUpSecondary.value.set(e.state===0||e.state===2?1:0,e.button):t._pointerUpSecondary.value.set(1,e.button)}if("_pointerUpFrame"in t){const e="_pointerData"in n.renderer?n.renderer._pointerData:h;t._pointerUpFrame.value.set(e.stateFrame===2?1:0,e.button)}if("_pointerUpPrimaryFrame"in t){const e="_pointerData"in n.renderer?n.renderer._pointerData:h;e.button===0?t._pointerUpPrimaryFrame.value.set(e.stateFrame===2?1:0,e.button):t._pointerUpPrimaryFrame.value.set(0,e.button)}if("_pointerUpAuxiliaryFrame"in t){const e="_pointerData"in n.renderer?n.renderer._pointerData:h;e.button===1?t._pointerUpAuxiliaryFrame.value.set(e.stateFrame===2?1:0,e.button):t._pointerUpAuxiliaryFrame.value.set(0,e.button)}if("_pointerUpSecondaryFrame"in t){const e="_pointerData"in n.renderer?n.renderer._pointerData:h;e.button===2?t._pointerUpSecondaryFrame.value.set(e.stateFrame===2?1:0,e.button):t._pointerUpSecondaryFrame.value.set(0,e.button)}if("_pointerEnter"in t){const e="_pointerData"in n.renderer?n.renderer._pointerData:h;t._pointerEnter.value=e.viewportState===1?1:0}if("_pointerLeave"in t){const e="_pointerData"in n.renderer?n.renderer._pointerData:h;t._pointerLeave.value=e.viewportState===0||e.viewportState===2?1:0}if("_pointerEnterFrame"in t){const e="_pointerData"in n.renderer?n.renderer._pointerData:h;t._pointerEnterFrame.value=e.viewportStateFrame===1?1:0}if("_pointerLeaveFrame"in t){const e="_pointerData"in n.renderer?n.renderer._pointerData:h;t._pointerLeaveFrame.value=e.viewportStateFrame===2?1:0}if("_keyboardTexture"in t){const e="_keyboardTexture"in n.renderer?n.renderer._keyboardTexture:null;t._keyboardTexture.value=e}},S=new _.Vector3(0,0,0),A=new _.Vector3(0,0,0),C=new _.Vector3(0,0,0);let g=new _.Vector2(0,0);var K={exports:{}};(function(n){var t=Object.prototype.hasOwnProperty,e="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(e=!1));function i(l,a,s){this.fn=l,this.context=a,this.once=s||!1}function c(l,a,s,d,D){if(typeof s!="function")throw new TypeError("The listener must be a function");var b=new i(s,d||l,D),u=e?e+a:a;return l._events[u]?l._events[u].fn?l._events[u]=[l._events[u],b]:l._events[u].push(b):(l._events[u]=b,l._eventsCount++),l}function y(l,a){--l._eventsCount===0?l._events=new r:delete l._events[a]}function v(){this._events=new r,this._eventsCount=0}v.prototype.eventNames=function(){var a=[],s,d;if(this._eventsCount===0)return a;for(d in s=this._events)t.call(s,d)&&a.push(e?d.slice(1):d);return Object.getOwnPropertySymbols?a.concat(Object.getOwnPropertySymbols(s)):a},v.prototype.listeners=function(a){var s=e?e+a:a,d=this._events[s];if(!d)return[];if(d.fn)return[d.fn];for(var D=0,b=d.length,u=new Array(b);D<b;D++)u[D]=d[D].fn;return u},v.prototype.listenerCount=function(a){var s=e?e+a:a,d=this._events[s];return d?d.fn?1:d.length:0},v.prototype.emit=function(a,s,d,D,b,u){var P=e?e+a:a;if(!this._events[P])return!1;var o=this._events[P],f=arguments.length,F,w;if(o.fn){switch(o.once&&this.removeListener(a,o.fn,void 0,!0),f){case 1:return o.fn.call(o.context),!0;case 2:return o.fn.call(o.context,s),!0;case 3:return o.fn.call(o.context,s,d),!0;case 4:return o.fn.call(o.context,s,d,D),!0;case 5:return o.fn.call(o.context,s,d,D,b),!0;case 6:return o.fn.call(o.context,s,d,D,b,u),!0}for(w=1,F=new Array(f-1);w<f;w++)F[w-1]=arguments[w];o.fn.apply(o.context,F)}else{var re=o.length,T;for(w=0;w<re;w++)switch(o[w].once&&this.removeListener(a,o[w].fn,void 0,!0),f){case 1:o[w].fn.call(o[w].context);break;case 2:o[w].fn.call(o[w].context,s);break;case 3:o[w].fn.call(o[w].context,s,d);break;case 4:o[w].fn.call(o[w].context,s,d,D);break;default:if(!F)for(T=1,F=new Array(f-1);T<f;T++)F[T-1]=arguments[T];o[w].fn.apply(o[w].context,F)}}return!0},v.prototype.on=function(a,s,d){return c(this,a,s,d,!1)},v.prototype.once=function(a,s,d){return c(this,a,s,d,!0)},v.prototype.removeListener=function(a,s,d,D){var b=e?e+a:a;if(!this._events[b])return this;if(!s)return y(this,b),this;var u=this._events[b];if(u.fn)u.fn===s&&(!D||u.once)&&(!d||u.context===d)&&y(this,b);else{for(var P=0,o=[],f=u.length;P<f;P++)(u[P].fn!==s||D&&!u[P].once||d&&u[P].context!==d)&&o.push(u[P]);o.length?this._events[b]=o.length===1?o[0]:o:y(this,b)}return this},v.prototype.removeAllListeners=function(a){var s;return a?(s=e?e+a:a,this._events[s]&&y(this,s)):(this._events=new r,this._eventsCount=0),this},v.prototype.off=v.prototype.removeListener,v.prototype.addListener=v.prototype.on,v.prefixed=e,v.EventEmitter=v,n.exports=v})(K);const Q=K.exports;class Z{constructor(){x(this,"events");x(this,"requests",[]);x(this,"cache",{});this.events=new Q}load(t){this.requests.includes(t)||(this.requests.push(t),fetch(t).then(e=>e.json()).then(e=>{G("graph.load",{url:t,href:window.location.href}),this.cache[t]=e,this.events.emit("load",{url:t,data:e})}))}}const E=n=>n instanceof Date,ee=n=>Object.keys(n).length===0,O=n=>n!=null&&typeof n=="object",k=(n,...t)=>Object.prototype.hasOwnProperty.call(n,...t),V=n=>O(n)&&ee(n),te=()=>Object.create(null),R=(n,t)=>{if(n===t)return{};if(!O(n)||!O(t))return t;const e=Object.keys(n).reduce((r,i)=>(k(t,i)||(r[i]=void 0),r),te());return E(n)||E(t)?n.valueOf()==t.valueOf()?{}:t:Object.keys(t).reduce((r,i)=>{if(!k(n,i))return r[i]=t[i],r;const c=R(n[i],t[i]);return V(c)&&!E(c)&&(V(n[i])||!V(t[i]))||(r[i]=c),r},e)},ne=n=>{if(typeof n!="object"||n===null)return!1;const t=Object.getPrototypeOf(n);return(t===null||t===Object.prototype||Object.getPrototypeOf(t)===null)&&!(Symbol.toStringTag in n)&&!(Symbol.iterator in n)},B=n=>ne(n)?Object.keys(n).reduce((t,e)=>{if(e==="__esModule")return t;const r=Object.getOwnPropertyDescriptor(n,e),i=r&&"get"in r,c=n[e];return i?Object.defineProperty(t,e,r):t[e]=B(c),t},{}):Array.isArray(n)?n.map(t=>B(t)):n;p.GraphLoader=Z,p.RendererDOM=Y,p.deepCopy=B,p.diff=R,p.generateUniforms=I,p.getFullURL=$,p.getUniformValue=z,p.initReactThreeFiber=m,p.initThree=H,p.materialUpdate=J,Object.defineProperties(p,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
