(function(u,P){typeof exports=="object"&&typeof module!="undefined"?P(exports,require("react"),require("@react-three/fiber"),require("three")):typeof define=="function"&&define.amd?define(["exports","react","@react-three/fiber","three"],P):(u=typeof globalThis!="undefined"?globalThis:u||self,P(u["react-nodetoy"]={},u.React,u.fiber,u.h))})(this,function(u,P,K,Z){"use strict";function J(e){return e&&typeof e=="object"&&"default"in e?e:{default:e}}function ee(e){if(e&&e.__esModule)return e;var t=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});return e&&Object.keys(e).forEach(function(r){if(r!=="default"){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}}),t.default=e,Object.freeze(t)}var N=J(P),s=ee(Z),te=Object.defineProperty,re=Object.defineProperties,ie=Object.getOwnPropertyDescriptors,G=Object.getOwnPropertySymbols,ne=Object.prototype.hasOwnProperty,oe=Object.prototype.propertyIsEnumerable,L=(e,t,r)=>t in e?te(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,O=(e,t)=>{for(var r in t||(t={}))ne.call(t,r)&&L(e,r,t[r]);if(G)for(var r of G(t))oe.call(t,r)&&L(e,r,t[r]);return e},E=(e,t)=>re(e,ie(t)),y=(e,t,r)=>(L(e,typeof t!="symbol"?t+"":t,r),r),ae=Object.defineProperty,se=(e,t,r)=>t in e?ae(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,w=(e,t,r)=>(se(e,typeof t!="symbol"?t+"":t,r),r);const le=(e,t={})=>{A("event",e,t)},de=(e,t={})=>{if(typeof window>"u")return;const r="ga-gtag";if(document.getElementById(r)){console.error("Already has a gtag script.");return}const{head:n}=document,i=document.createElement("script");i.id=r,i.type="text/javascript",i.async=!0,i.src=`https://www.googletagmanager.com/gtag/js?id=${e}`,n.insertBefore(i,n.firstChild),window.dataLayer=window.dataLayer||[],A("js",new Date),A("config",e,t)},A=function(...e){window.dataLayer.push(arguments)},ce=new s.TextureLoader,B={},h={state:0,stateFrame:0,button:0,viewportState:0,viewportStateFrame:0,x:0,y:0};class ue extends s.DataTexture{constructor(){const t=new Uint8Array(1024);for(let r=0;r<4*256;r++)t[r]=0;super(t,256,1,s.RGBAFormat),w(this,"data"),w(this,"_size"),this.data=t,this.flipY=!0,this._size=256}setKeyDown(t){const r=t*4;this.data[r+0]!==255&&(this.data[r+0]=255,this.data[r+1]=255,this.data[r+2]=255-this.data[r+2],this.needsUpdate=!0)}setKeyUp(t){const r=t*4;this.data[r+0]=0,this.data[r+1]=0,this.needsUpdate=!0}clear(){for(let t=0;t<4*this._size;t++)this.data[t]=0;this.needsUpdate=!0}clearFrame(){for(let t=0;t<this._size;t++){const r=t*4;this.data[r+1]=0}this.needsUpdate=!0}}class he{constructor(t){w(this,"renderer"),w(this,"_keyboardTexture",new ue),w(this,"_onPointerMoveBind"),w(this,"_onPointerDownBind"),w(this,"_onPointerUpBind"),w(this,"_onPointerEnterBind"),w(this,"_onPointerLeaveBind"),w(this,"_onKeyDownBind"),w(this,"_onKeyUpBind"),this.renderer=t,this.renderer._pointerPosition={x:0,y:0},this.renderer._pointerData=h,this.renderer._keyboardTexture=this._keyboardTexture;const r=t.domElement;if(!r){console.warn("[NodeToy] Unable to bind dom events, domElement is null. Some nodes will not work.");return}this._onPointerMoveBind=this.onPointerMove.bind(this),this._onPointerDownBind=this.onPointerDown.bind(this),this._onPointerUpBind=this.onPointerUp.bind(this),this._onPointerEnterBind=this.onPointerEnter.bind(this),this._onPointerLeaveBind=this.onPointerLeave.bind(this),this._onKeyDownBind=this.onKeyDown.bind(this),this._onKeyUpBind=this.onKeyUp.bind(this),r.addEventListener("pointermove",this._onPointerMoveBind),r.addEventListener("pointerdown",this._onPointerDownBind),r.addEventListener("pointerup",this._onPointerUpBind),r.addEventListener("pointerenter",this._onPointerEnterBind),r.addEventListener("pointerleave",this._onPointerLeaveBind),window.addEventListener("keydown",this._onKeyDownBind),window.addEventListener("keyup",this._onKeyUpBind)}dispose(){if(!this.renderer)return;const t=this.renderer.domElement;!t||(t.removeEventListener("pointermove",this._onPointerMoveBind),t.removeEventListener("pointerdown",this._onPointerDownBind),t.removeEventListener("pointerup",this._onPointerUpBind),t.removeEventListener("pointerenter",this._onPointerEnterBind),t.removeEventListener("pointerleave",this._onPointerLeaveBind),window.removeEventListener("keydown",this._onKeyDownBind),window.removeEventListener("keyup",this._onKeyUpBind))}onPointerMove(t){!this.renderer||(this.renderer._pointerPosition={x:Math.floor(t.offsetX),y:Math.floor(t.offsetY)})}onPointerDown(t){!this.renderer||(this.renderer._pointerData=E(O({},this.renderer._pointerData),{state:1,stateFrame:1,button:t.button,x:Math.floor(t.offsetX),y:Math.floor(t.offsetY)}))}onPointerUp(t){!this.renderer||(this.renderer._pointerData=E(O({},this.renderer._pointerData),{state:2,stateFrame:2,button:t.button,x:Math.floor(t.offsetX),y:Math.floor(t.offsetY)}))}onPointerEnter(t){!this.renderer||(this.renderer._pointerData=E(O({},this.renderer._pointerData),{viewportState:1,viewportStateFrame:1,x:Math.floor(t.offsetX),y:Math.floor(t.offsetY)}))}onPointerLeave(t){!this.renderer||(this.renderer._pointerData=E(O({},this.renderer._pointerData),{viewportState:2,viewportStateFrame:2,x:Math.floor(t.offsetX),y:Math.floor(t.offsetY)}))}onKeyDown(t){!this.renderer||this._keyboardTexture.setKeyDown(t.keyCode)}onKeyUp(t){!this.renderer||this._keyboardTexture.setKeyUp(t.keyCode)}}const pe=e=>e.includes(".json")?e:`${e}${e[e.length-1]!="/"?"/":""}material.glsl.json`,fe=(e,t)=>{if(!e||!t.includes("asset:"))return t;const r=e[e.length-1];return`${e}${r!=="/"?"/":""}assets/${t.replace("asset:","")}`},V=(e,t,r,n={})=>{const i=t;for(let a=0;a<r.length;a++){const p=r[a],f=p.name in n?n[p.name]:p.value;i[p.name]={value:q(e,p.type,f),type:p.type}}return i},q=(e,t,r)=>{switch(t){case"int":case"float":return r;case"vec2":return r!=null?new s.Vector2(r.x,r.y):new s.Vector2(0,0);case"vec3":return r!=null?new s.Vector3(r.x,r.y,r.z):new s.Vector3(0,0,0);case"vec4":return r!=null?new s.Vector4(r.x,r.y,r.z,r.w):new s.Vector4(0,0,0);case"mat3":return r||new s.Matrix3;case"mat4":return r||new s.Matrix4;case"texture":{if(r in B)return B[r];const n=ce.load(fe(e,r));return n.wrapS=n.wrapT=s.RepeatWrapping,B[r]=n,n}}return"undefined"},_e=()=>{de("G-D7559MFFX3")},me=(e,t)=>{for(let r=0;r<e.scene.children.length;r++)if(e.scene.children[r].isDirectionalLight){e.light=e.scene.children[r];break}if("_sinTime"in t){const r=Math.sin(e.time);t._sinTime.value.set(r/8,r/4,r/2,r)}if("_cosTime"in t){const r=Math.cos(e.time);t._cosTime.value.set(r/8,r/4,r/2,r)}if("_objectScale"in t){const r=e.object;t._objectScale.value=r.scale}if("_time"in t&&(t._time.value=e.time),"_deltaTime"in t&&t._deltaTime.value.set(e.deltaTime,1/e.deltaTime,0,0),"_objectSpaceViewDir"in t){const r=e.object,n=e.camera,i=new s.Vector4(n.position.x,n.position.y,n.position.z),a=r.matrixWorld.clone().invert().elements,p=a[0]*i.x+a[4]*i.y+a[8]*i.z+a[12]*i.w,f=a[1]*i.x+a[5]*i.y+a[9]*i.z+a[13]*i.w,o=a[2]*i.x+a[6]*i.y+a[10]*i.z+a[14]*i.w,l=a[3]*i.x+a[7]*i.y+a[11]*i.z+a[15]*i.w,d=new s.Vector4(p,f,o,l);t._objectSpaceViewDir.value=d}if("_cameraPosition"in t){const r=e.camera;t._cameraPosition.value=r.position.clone()}if("_worldSpaceCameraPosition"in t&&(e.camera.getWorldDirection($),t._worldSpaceCameraPosition.value=$),"_worldSpaceLightPosition"in t&&(e.light.getWorldDirection(Y),t._worldSpaceLightPosition.value=Y),"_worldToObject"in t){const r=e.object;t._worldToObject.value=r.matrixWorld.clone().invert()}if("_worldToObjMatrix"in t&&(t._worldToObjMatrix.value=e.object.matrixWorld.clone().invert()),"_worldToCameraMatrix"in t){const r=e.camera;t._worldToCameraMatrix.value=r.matrixWorldInverse.clone()}if("_viewProjectionMatrix"in t){const r=e.camera,n=r.matrixWorld.clone();t._viewProjectionMatrix.value=r.projectionMatrix.clone().multiply(n)}if("_viewMatrix"in t){const r=e.camera;t._viewMatrix.value=r.matrixWorldInverse}if("_transposeModelViewMatrix"in t){const r=e.object;t._transposeModelViewMatrix.value=r.modelViewMatrix.clone().transpose()}if("_inverseTransposeModelViewMatrix"in t){const r=e.object.modelViewMatrix.clone();t._inverseTransposeModelViewMatrix.value=r.invert().transpose()}if("_projectionMatrix"in t){const r=e.camera;t._projectionMatrix.value=r.projectionMatrix}if("_projectionParams"in t){const r=e.camera;t._projectionParams.value=new s.Vector4(1,r.near,r.far,1/r.far)}if("_inverseProjectionMatrix"in t){const r=e.camera;t._inverseProjectionMatrix.value=r.projectionMatrixInverse}if("_objectToWorldMatrix"in t){const r=e.object;t._objectToWorldMatrix.value=r.matrixWorld}if("_modelViewProjectionMatrix"in t){const r=e.object,n=e.camera;n.updateMatrixWorld(!0),r.updateMatrixWorld(!0);const i=r.modelViewMatrix.clone();t._modelViewProjectionMatrix.value=n.projectionMatrix.clone().multiply(i)}if("_modelViewMatrix"in t){const r=e.object;e.camera.updateMatrixWorld(!0),r.updateMatrixWorld(!0),t._modelViewMatrix.value=r.modelViewMatrix.clone()}if("_inverseModelViewMatrix"in t){const r=e.object;e.camera.updateMatrixWorld(!0),r.updateMatrixWorld(!0),t._inverseModelViewMatrix.value=r.modelViewMatrix.clone().invert()}if("_modelMatrix"in t){const r=e.object;t._modelMatrix.value=r.matrixWorld}if("_normalMatrix"in t){const r=e.object;t._normalMatrix.value=r.normalMatrix}if("_inverseViewMatrix"in t){const r=e.camera;t._inverseViewMatrix.value=r.matrixWorldInverse.clone().invert()}if("_cameraToWorldMatrix"in t){const r=e.camera;t._cameraToWorldMatrix.value=r.matrixWorldInverse.clone().invert()}if("_worldSpaceLightDir"in t&&e.light&&(t._worldSpaceLightDir.value=new s.Vector3(e.light.rotation._x,e.light.rotation._y,e.light.rotation._z).normalize()),"_lightColor"in t&&e.light){const r=e.light.intensity,n=new s.Vector3(e.light.color.r*r,e.light.color.g*r,e.light.color.b*r);t._lightColor.value=n}if("_screenSize"in t&&(e.renderer.getSize(g),t._screenSize.value.set(Math.floor(g.x),Math.floor(g.y),1+1/Math.floor(g.x),1+1/Math.floor(g.y))),"_viewDir"in t&&(e.camera.getWorldDirection(k),k.negate(),t._viewDir.value=k),"_pointerPosition"in t){const r="_pointerPosition"in e.renderer?e.renderer._pointerPosition:{x:0,y:0};t._pointerPosition.value.set(Math.floor(r.x),Math.floor(r.y))}if("_pointerPositionNormalized"in t){e.renderer.getSize(g);const r="_pointerPosition"in e.renderer?e.renderer._pointerPosition:{x:0,y:0};t._pointerPositionNormalized.value.set(r.x/g.x,r.y/g.y)}if("_pointerDown"in t){const r="_pointerData"in e.renderer?e.renderer._pointerData:h;t._pointerDown.value.set(r.state===1?1:0,r.button)}if("_pointerDownPrimary"in t){const r="_pointerData"in e.renderer?e.renderer._pointerData:h;r.button===0&&t._pointerDownPrimary.value.set(r.state===1?1:0,r.button)}if("_pointerDownAuxiliary"in t){const r="_pointerData"in e.renderer?e.renderer._pointerData:h;r.button===1&&t._pointerDownAuxiliary.value.set(r.state===1?1:0,r.button)}if("_pointerDownSecondary"in t){const r="_pointerData"in e.renderer?e.renderer._pointerData:h;r.button===2&&t._pointerDownSecondary.value.set(r.state===1?1:0,r.button)}if("_pointerDownFrame"in t){const r="_pointerData"in e.renderer?e.renderer._pointerData:h;t._pointerDownFrame.value.set(r.stateFrame===1?1:0,r.button)}if("_pointerDownPrimaryFrame"in t){const r="_pointerData"in e.renderer?e.renderer._pointerData:h;r.button===0&&t._pointerDownPrimaryFrame.value.set(r.stateFrame===1?1:0,r.button)}if("_pointerDownAuxiliaryFrame"in t){const r="_pointerData"in e.renderer?e.renderer._pointerData:h;r.button===1&&t._pointerDownAuxiliaryFrame.value.set(r.stateFrame===1?1:0,r.button)}if("_pointerDownSecondaryFrame"in t){const r="_pointerData"in e.renderer?e.renderer._pointerData:h;r.button===2&&t._pointerDownSecondaryFrame.value.set(r.stateFrame===1?1:0,r.button)}if("_pointerUp"in t){const r="_pointerData"in e.renderer?e.renderer._pointerData:h;t._pointerUp.value.set(r.state===0||r.state===2?1:0,r.button)}if("_pointerUpPrimary"in t){const r="_pointerData"in e.renderer?e.renderer._pointerData:h;r.button===0?t._pointerUpPrimary.value.set(r.state===0||r.state===2?1:0,r.button):t._pointerUpPrimary.value.set(1,r.button)}if("_pointerUpAuxiliary"in t){const r="_pointerData"in e.renderer?e.renderer._pointerData:h;r.button===1?t._pointerUpAuxiliary.value.set(r.state===0||r.state===2?1:0,r.button):t._pointerUpAuxiliary.value.set(1,r.button)}if("_pointerUpSecondary"in t){const r="_pointerData"in e.renderer?e.renderer._pointerData:h;r.button===2?t._pointerUpSecondary.value.set(r.state===0||r.state===2?1:0,r.button):t._pointerUpSecondary.value.set(1,r.button)}if("_pointerUpFrame"in t){const r="_pointerData"in e.renderer?e.renderer._pointerData:h;t._pointerUpFrame.value.set(r.stateFrame===2?1:0,r.button)}if("_pointerUpPrimaryFrame"in t){const r="_pointerData"in e.renderer?e.renderer._pointerData:h;r.button===0?t._pointerUpPrimaryFrame.value.set(r.stateFrame===2?1:0,r.button):t._pointerUpPrimaryFrame.value.set(0,r.button)}if("_pointerUpAuxiliaryFrame"in t){const r="_pointerData"in e.renderer?e.renderer._pointerData:h;r.button===1?t._pointerUpAuxiliaryFrame.value.set(r.stateFrame===2?1:0,r.button):t._pointerUpAuxiliaryFrame.value.set(0,r.button)}if("_pointerUpSecondaryFrame"in t){const r="_pointerData"in e.renderer?e.renderer._pointerData:h;r.button===2?t._pointerUpSecondaryFrame.value.set(r.stateFrame===2?1:0,r.button):t._pointerUpSecondaryFrame.value.set(0,r.button)}if("_pointerEnter"in t){const r="_pointerData"in e.renderer?e.renderer._pointerData:h;t._pointerEnter.value=r.viewportState===1?1:0}if("_pointerLeave"in t){const r="_pointerData"in e.renderer?e.renderer._pointerData:h;t._pointerLeave.value=r.viewportState===0||r.viewportState===2?1:0}if("_pointerEnterFrame"in t){const r="_pointerData"in e.renderer?e.renderer._pointerData:h;t._pointerEnterFrame.value=r.viewportStateFrame===1?1:0}if("_pointerLeaveFrame"in t){const r="_pointerData"in e.renderer?e.renderer._pointerData:h;t._pointerLeaveFrame.value=r.viewportStateFrame===2?1:0}if("_keyboardTexture"in t){const r="_keyboardTexture"in e.renderer?e.renderer._keyboardTexture:null;t._keyboardTexture.value=r}},k=new s.Vector3(0,0,0),$=new s.Vector3(0,0,0),Y=new s.Vector3(0,0,0);let g=new s.Vector2(0,0);var X={exports:{}};(function(e){var t=Object.prototype.hasOwnProperty,r="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(r=!1));function i(o,l,d){this.fn=o,this.context=l,this.once=d||!1}function a(o,l,d,M,b){if(typeof d!="function")throw new TypeError("The listener must be a function");var m=new i(d,M||o,b),v=r?r+l:l;return o._events[v]?o._events[v].fn?o._events[v]=[o._events[v],m]:o._events[v].push(m):(o._events[v]=m,o._eventsCount++),o}function p(o,l){--o._eventsCount===0?o._events=new n:delete o._events[l]}function f(){this._events=new n,this._eventsCount=0}f.prototype.eventNames=function(){var o=[],l,d;if(this._eventsCount===0)return o;for(d in l=this._events)t.call(l,d)&&o.push(r?d.slice(1):d);return Object.getOwnPropertySymbols?o.concat(Object.getOwnPropertySymbols(l)):o},f.prototype.listeners=function(o){var l=r?r+o:o,d=this._events[l];if(!d)return[];if(d.fn)return[d.fn];for(var M=0,b=d.length,m=new Array(b);M<b;M++)m[M]=d[M].fn;return m},f.prototype.listenerCount=function(o){var l=r?r+o:o,d=this._events[l];return d?d.fn?1:d.length:0},f.prototype.emit=function(o,l,d,M,b,m){var v=r?r+o:o;if(!this._events[v])return!1;var c=this._events[v],x=arguments.length,T,_;if(c.fn){switch(c.once&&this.removeListener(o,c.fn,void 0,!0),x){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,l),!0;case 3:return c.fn.call(c.context,l,d),!0;case 4:return c.fn.call(c.context,l,d,M),!0;case 5:return c.fn.call(c.context,l,d,M,b),!0;case 6:return c.fn.call(c.context,l,d,M,b,m),!0}for(_=1,T=new Array(x-1);_<x;_++)T[_-1]=arguments[_];c.fn.apply(c.context,T)}else{var Te=c.length,j;for(_=0;_<Te;_++)switch(c[_].once&&this.removeListener(o,c[_].fn,void 0,!0),x){case 1:c[_].fn.call(c[_].context);break;case 2:c[_].fn.call(c[_].context,l);break;case 3:c[_].fn.call(c[_].context,l,d);break;case 4:c[_].fn.call(c[_].context,l,d,M);break;default:if(!T)for(j=1,T=new Array(x-1);j<x;j++)T[j-1]=arguments[j];c[_].fn.apply(c[_].context,T)}}return!0},f.prototype.on=function(o,l,d){return a(this,o,l,d,!1)},f.prototype.once=function(o,l,d){return a(this,o,l,d,!0)},f.prototype.removeListener=function(o,l,d,M){var b=r?r+o:o;if(!this._events[b])return this;if(!l)return p(this,b),this;var m=this._events[b];if(m.fn)m.fn===l&&(!M||m.once)&&(!d||m.context===d)&&p(this,b);else{for(var v=0,c=[],x=m.length;v<x;v++)(m[v].fn!==l||M&&!m[v].once||d&&m[v].context!==d)&&c.push(m[v]);c.length?this._events[b]=c.length===1?c[0]:c:p(this,b)}return this},f.prototype.removeAllListeners=function(o){var l;return o?(l=r?r+o:o,this._events[l]&&p(this,l)):(this._events=new n,this._eventsCount=0),this},f.prototype.off=f.prototype.removeListener,f.prototype.addListener=f.prototype.on,f.prefixed=r,f.EventEmitter=f,e.exports=f})(X);const ve=X.exports;class ye{constructor(){w(this,"events"),w(this,"requests",[]),w(this,"cache",{}),this.events=new ve}load(t){this.requests.includes(t)||(this.requests.push(t),fetch(t).then(r=>r.json()).then(r=>{le("graph.load",{url:t,href:window.location.href}),this.cache[t]=r,this.events.emit("load",{url:t,data:r})}))}}const C=e=>e instanceof Date,we=e=>Object.keys(e).length===0,W=e=>e!=null&&typeof e=="object",H=(e,...t)=>Object.prototype.hasOwnProperty.call(e,...t),R=e=>W(e)&&we(e),Me=()=>Object.create(null),Q=(e,t)=>{if(e===t)return{};if(!W(e)||!W(t))return t;const r=Object.keys(e).reduce((n,i)=>(H(t,i)||(n[i]=void 0),n),Me());return C(e)||C(t)?e.valueOf()==t.valueOf()?{}:t:Object.keys(t).reduce((n,i)=>{if(!H(e,i))return n[i]=t[i],n;const a=Q(e[i],t[i]);return R(a)&&!C(a)&&(R(e[i])||!R(t[i]))||(n[i]=a),n},r)},be=e=>{if(typeof e!="object"||e===null)return!1;const t=Object.getPrototypeOf(e);return(t===null||t===Object.prototype||Object.getPrototypeOf(t)===null)&&!(Symbol.toStringTag in e)&&!(Symbol.iterator in e)},U=e=>be(e)?Object.keys(e).reduce((t,r)=>{if(r==="__esModule")return t;const n=Object.getOwnPropertyDescriptor(e,r),i=n&&"get"in n,a=e[r];return i?Object.defineProperty(t,r,n):t[r]=U(a),t},{}):Array.isArray(e)?e.map(t=>U(t)):e;_e();const F=new ye,ge=306;u.NodeToyCullMode=void 0,function(e){e.Front="front",e.Back="back",e.None="none"}(u.NodeToyCullMode||(u.NodeToyCullMode={})),u.NodeToyMaterialType=void 0,function(e){e.Standard="standard",e.Physical="physical",e.Unlit="unlit",e.Image="image"}(u.NodeToyMaterialType||(u.NodeToyMaterialType={}));var z;(function(e){e.Opaque="opaque",e.Transparent="transparent"})(z||(z={}));const D=class extends s.ShaderMaterial{constructor(e){super(),y(this,"verbose",!1),y(this,"resetUniformByName",t=>{this.resetUniformsByName([t])}),y(this,"resetUniformsByName",t=>{for(let r=0;r<t.length;r++){const n=t[r];for(let i=0;i<this._data.uniforms.length;i++){const a=this._data.uniforms[i];if(a.name===n){this.uniforms[a.name]={value:q(this._url,a.type,a.value),type:a.type};break}}}}),y(this,"_fullURL",null),y(this,"_url",null),y(this,"_data",null),y(this,"_parameters",{}),y(this,"_cullMode",u.NodeToyCullMode.Back),y(this,"_type",u.NodeToyMaterialType.Unlit),y(this,"_options",{}),y(this,"_envUUID",null),this.toneMapped=!1,this.flatShading=!1,this.transparent=!0,this.onBeforeRender=this.onBeforeRender,this.normalMap=new s.Texture,this.tangentSpaceNormalMap=new s.Texture,this.aoMap=new s.Texture,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.depthTest=!0,this.depthWrite=!0,this.envMapIntensity=1,this.side=s.FrontSide,this.vertexShader=s.ShaderLib.standard.vertexShader,this.fragmentShader=s.ShaderLib.standard.fragmentShader,this.defines={STANDARD:"",USE_NORMALMAP:"",USE_TANGENT:"",TANGENTSPACE_NORMALMAP:""},this.uniforms=U(s.ShaderLib.physical.uniforms),this.uniforms.spotShadowMatrix={value:[new s.Matrix4]},this.lights=!0,this.isShaderMaterial=!0,this.isMeshStandardMaterial=!1,this.type="ShaderMaterial",this.combine=s.MultiplyOperation,e&&("verbose"in e&&(this.verbose=e.verbose),"url"in e&&(this.url=e.url),"toneMapped"in e&&(this.toneMapped=e.toneMapped),"flatShading"in e&&(this.flatShading=e.flatShading),"transparent"in e&&(this.transparent=e.transparent),"cullMode"in e&&(this.cullMode=e.cullMode),this._parameters=e.parameters?e.parameters:null,"polygonOffset"in e&&(this.polygonOffset=e.polygonOffset),"polygonOffsetFactor"in e&&(this.polygonOffsetFactor=e.polygonOffsetFactor),"depthTest"in e&&(this.depthTest=e.depthTest),"depthWrite"in e&&(this.depthWrite=e.depthWrite),"envMapIntensity"in e&&(this.envMapIntensity=e.envMapIntensity),"data"in e&&(this.data=e.data),this._options=e),F.events.on("load",t=>{t.url===this._fullURL&&this.loadShader(t.data)})}static tick(){D._time.deltaTime=D._clock.getDelta(),D._time.time+=D._time.deltaTime}get cullMode(){return this._cullMode}set cullMode(e){this._cullMode=e,this.side=this.getTHREECullMode(e)}recompile(){this.version++,this.dispose()}clone(){return new this.constructor().copy(this)}copy(e){return super.copy(e),this._url=e._url,this._data=e._data,this.verbose=e.verbose,this._parameters&&(this._parameters=O({},e._parameters)),this.vertexShader=e.vertexShader,this.fragmentShader=e.fragmentShader,this.uniforms=U(e.uniforms),this.recompile(),this}get url(){return this._url}set url(e){if(this._url=e,e){const t=this._fullURL=pe(e);this.verbose&&console.log(`[NodeToy] loading graph... | url: ${t}`),t in F.cache?this.loadShader(F.cache[t]):F.load(t)}else console.warn("[NodeToy] Missing material graph URL. Cannot load shader.")}get data(){return this._data}set data(e){if(!e){console.warn("[NodeToy] Missing material graph data. Cannot load shader.");return}this.verbose&&console.log("[NodeToy] seting graph data... | data:",e),this.loadShader(e)}get parameters(){return this._parameters}set parameters(e){if(this._parameters=e,this._data){const t=this._data.uniforms,r=U(this.uniforms),n=V(this.url,this.uniforms,t,e),i=Object.keys(Q(r,n));for(let a=0;a<i.length;a++){const p=i[a];this.uniforms[p]=n[p]}}}updateUniforms(e){let t=[];if(Object.assign(t,e),this._parameters!==null)for(const r in this._parameters)for(let n=0;n<t.length;n++)r===t[n].name&&(t[n].value=this._parameters[r]);return t}loadShader(e){this.verbose&&console.log("[NodeToy] graph loaded.",e,V(this.url,this.uniforms,e.uniforms)),this._data=e,this.vertexShader=e.vertex,this.fragmentShader=e.fragment;const t=this.updateUniforms(e.uniforms);this.uniforms=V(this.url,this.uniforms,t),this.recompile(),"cullMode"in e&&!("cullMode"in this._options)&&(this.cullMode=e.cullMode),"lightModel"in e&&(this._type=e.lightModel),"renderType"in e&&(this.transparent=e.renderType===z.Transparent)}onBeforeRender(e,t,r,n,i){const a={camera:r,object:i,renderer:e,scene:t,light:null,time:D._time.time,deltaTime:D._time.deltaTime};if(e._rendererDOM||(e._rendererDOM=new he(e)),this.uniforms&&me(a,this.uniforms),t.environment&&this._type!==u.NodeToyMaterialType.Unlit){if(this._envUUID!=t.environment.uuid){this._envUUID=t.environment.uuid;const p=t.environment.clone();p.mapping=s.CubeUVReflectionMapping,this.envMap=p,this.envMap.mapping=s.CubeUVReflectionMapping,this.envMapMode=ge,this.uniforms.envMap.value=p,this.uniforms.envMapIntensity.value=this.envMapIntensity}this.defines={STANDARD:"",USE_NORMALMAP:"",USE_ENVMAP:"",ENVMAP_TYPE_CUBE_UV:"",USE_TANGENT:"",TANGENTSPACE_NORMALMAP:""}}else this.envMap=null,"envMap"in this.uniforms&&(this.uniforms.envMap.value=null),this.defines={STANDARD:"",USE_NORMALMAP:"",USE_TANGENT:"",TANGENTSPACE_NORMALMAP:""};t.fog&&(this.defines.USE_FOG="")}getTHREECullMode(e){return e===u.NodeToyCullMode.None?s.DoubleSide:e===u.NodeToyCullMode.Front?s.BackSide:s.FrontSide}};let S=D;y(S,"_bindDOMEvents",()=>{}),y(S,"_time",{time:0,deltaTime:0}),y(S,"_clock",new s.Clock),K.extend({ThreeNodeToyMaterial:S});const xe=P.forwardRef((e,t)=>N.default.createElement("threeNodeToyMaterial",{ref:t,url:e.url,data:e.data,parameters:e.parameters,toneMapped:e.toneMapped,flatShading:e.flatShading,transparent:e.transparent,cullMode:e.cullMode,verbose:e.verbose,polygonOffset:e.polygonOffset,polygonOffsetFactor:e.polygonOffsetFactor,depthTest:e.depthTest,depthWrite:e.depthTest,envMapIntensity:e.envMapIntensity,name:e.name})),De=()=>(K.useFrame(()=>{S.tick()}),N.default.createElement(N.default.Fragment,null)),I=(e,t,r)=>{if(Array.isArray(e))for(let n=0;n<e.length;n++){const i=e[n];i.isMesh&&i.material===t&&(i.material=r),i.children&&i.children.length&&I(i.children,t,r)}else I([e],t,r)};u.NodeToyMaterial=xe,u.NodeToyTick=De,u.ThreeNodeToyMaterial=S,u.swapMaterial=I,Object.defineProperties(u,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
